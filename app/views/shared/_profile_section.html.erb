<div class="profile-section" style="min-height: 300px;">
  <div class="loading">Loading ...</div>
</div>

<div id="profile-section-user-template" style="display: none;">
  <div style="width: 100%; height: 200px; background-image: url({{profile_banner_url}}); background-size:  cover; ">
  </div>
  <div style="margin-top: -50px;">
    <img class="rounded-circle border shadow-sm" data-src="{{profile_image_url}}" style="min-width: 100px; width: 30%; max-width: 150px;">
  </div>
  <div class="pt-3 px-3">
    <div class="d-flex justify-content-between mb-3">
      <div>
        <div><strong>{{name}}</strong></div>
        <div><a class="text-muted" href="https://twitter.com/{{screen_name}}" target="_blank">@{{screen_name}}</a></div>
      </div>
      <div>
        <button class="btn btn-outline-secondary btn-sm" type="button" data-toggle="collapse" aria-expanded="false" href=".profile-section-details"><%= t('.details') %></button>
      </div>
    </div>

    <div class="profile-section-details collapse">
      <div class="small mb-3">{{{description}}}</div>
      <div class="mb-3">
        <div class="d-inline-block mr-3">
          <i class="fas fa-map-marker-alt text-muted"></i>
          <span class="text-muted">{{location}}</span>
        </div>
        <div class="d-inline-block">
          <i class="fas fa-link text-muted"></i>
          <a class="text-muted" href="{{url}}" target="_blank">
            {{url_s}}
          </a>
        </div>
      </div>
      <div class="mb-3">
        <div class="d-inline-block mr-3">
          <a href="https://twitter.com/{{screen_name}}" target="_blank">
            <strong class="text-body">{{statuses_count_s}}</strong>
            <span class="text-muted"><%= t('.statuses') %></span>
          </a>
        </div>
        <div class="d-inline-block mr-3">
          <a href="https://twitter.com/{{screen_name}}/following" target="_blank">
            <strong class="text-body">{{friends_count_s}}</strong>
            <span class="text-muted"><%= t('.following') %></span>
          </a>
        </div>
        <div class="d-inline-block">
          <a href="https://twitter.com/{{screen_name}}/followers" target="_blank">
            <strong class="text-body">{{followers_count_s}}</strong>
            <span class="text-muted"><%= t('.followers') %></span>
          </a>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  function renderTemplate(user) {
    if (user.description) {
      user.description = user.description.replace('\n', '<br>').replace(/https?:\/\//g, '');
      user.description = linkifyHtml(user.description, {defaultProtocol: 'https'});
    }
    var template = $('#profile-section-user-template').html();
    var rendered = $(Mustache.render(template, user));
    rendered.find('img').each(function () {
      var img = $(this);
      img.attr('src', img.attr('data-src'));
    });
    return rendered;
  }

  function updateProfile(retryCount) {
    if (retryCount >= 3) {
      return;
    }

    var url = '<%= api_profile_path(uid: user.uid) %>';
    $.get(url).done(function (res) {
      var user = res.user;
      $('.profile-section').html(renderTemplate(user)).addClass('border').hide().fadeIn(500);
    }).fail(function (xhr) {
      if (xhr.status === 404) {
        setTimeout(function () {
          updateProfile(++retryCount);
        }, 3000);
      }
    });
  }

  $(function () {
    updateProfile(0);
  })
</script>
